---
layout: post
title: 网络服务器最大连接数64k的误解
---
<img src="{{ site.url }}/images/post/64k.jpg" class="excerpt">
想到这样的一个标题，我觉得很弱智，但是还是用这个了，因为这个标题很能直接说明我将要探讨的问题。不知道是从哪个叫兽还是某个人说的最大连接数64k这样的一个说法，直到现在还依然迷惑着众多不明所以的程序猿。对于**64K**这样一个词，我想很多人都见过，但是到底出处哪里，还有就是网络服务器与64k有什么关系呢？

<!-- ## -->

![]({{ site.url }}/images/post/64k.jpg)   

“64K”到底从哪里来的，其实这个是通过计算大体得出来的一个数字，但是却不是作为服务器的最大连接数，先不说服务器的最大连接数是多少，且得说说64K这个是什么意思，怎么算出来的。

###先说说怎么算出来的？
按照TCP协议包结构规定的IP-PORT，PORT在协议包中占用16bit，也就是总共可以有2^16-1(65535)个值。TCP端口分为静态端口和动态端口，其中静态端口（0-1024）是分配固定端口，从1025-65535为动态端口，也就是可供开发者使用的端口仅仅只有64511个，所以大家称为64K。

###再说说是什么意思呢？
通俗了讲就是一台电脑可以同时打开64K个网络连接。有同学可能就迷糊在这个地方了，这不就是最大64K个长连接嘛。单纯地看这个理论是没错，但是你得把这个数据放在不同的位置，作为客户端和作为服务器。

* 作为用户电脑，如果一个QQ只占一个长连接，那么最大可以登录64K个QQ，够直白了吧。

* 作为服务器，你可以开65535个服务端口，理论上来说，你可以在一台服务器上可以部署64K个占用端口的服务程序。其每一个服务程序（如apache）都可以保持几十万乃至几百万的客户端连接。看到这里应该可以明白64K不是大家通常所说的一台服务器能承载的最大并发连接数。

PS：一般一台服务器使用的端口数屈指可数，并不会出现服务器上运行太多的程序，大部分作为专用服务器，比如web服务器，应用服务器，游戏服务器等。


##那么究竟单台服务器能承载多大的并发连接呢？让我们进行测试一下：

根据TCP协议，一条网络连接的四要素，源IP+源PORT--》目的IP+目的PORT，客户端/服务器模式的网络连接，一般目的IP和PORT都是固定不变，也就是说服务器承载的最大连接数理论上是世界上IP数*(65535-1024)。

* 假定采用IPv4版本：`255*255*255*255≈42亿`
* 一台电脑的可分配PORT：`65535-1024=64511`
* 总计所有的可分配的资源客户端为：`255*255*255*255*(65535-1024)
≈27*10^13`,大约有27亿亿，这才是服务器理论承载的最大并发连接数。

PS：理论上的数字仅仅是作为一个参考，实际上单台服务器受限于内存、cpu、网卡带宽等因素的影响，实际应用会大大减少网络并发量，少则几万并发连接，多则50万、上百万连接不等。



